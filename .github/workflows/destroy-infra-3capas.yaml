name: ğŸ§¨ Destroy Infraestructura

on:
  workflow_dispatch: # Se activa manualmente desde GitHub Actions

jobs:
  destroy:
    name: ğŸ’£ Destruir Infraestructura Completa
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Descargar cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ” Configurar credenciales de AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_KEY }}
          aws-region: us-east-1

      - name: ğŸ§¹ Limpiar servicios de Kubernetes
        continue-on-error: true
        run: |
          echo "Intentando actualizar kubeconfig para el cluster proyecto06-eks..."
          if aws eks update-kubeconfig --name proyecto06-eks --region us-east-1; then
            echo "âœ“ Kubeconfig actualizado. Eliminando namespace proyecto06..."
            kubectl delete namespace proyecto06 --timeout=120s || echo "-> Namespace 'proyecto06' no encontrado o ya eliminado."
            echo "Esperando 30 segundos para la terminaciÃ³n de recursos..."
            sleep 30
          else
            echo "-> No se pudo conectar al cluster EKS. Es posible que ya haya sido eliminado. Saltando limpieza de Kubernetes."
          fi

      - name: ğŸ”§ Configurar Terraform
        uses: hashicorp/setup-terraform@v3

      - name: ğŸ—ï¸ Inicializar Terraform
        run: terraform init -upgrade
        working-directory: ./terraform

      - name: ğŸ’£ Destruir Infraestructura de EKS con Terraform
        run: terraform destroy -auto-approve -input=false
        working-directory: ./terraform

      - name: ğŸ—‘ï¸ Eliminar Repositorios ECR
        continue-on-error: true
        run: |
          echo "Eliminando repositorios ECR..."
          for service in frontend backend database; do
            REPO_NAME="proyecto06-$service"
            echo "Intentando eliminar el repositorio $REPO_NAME..."
            aws ecr delete-repository --repository-name $REPO_NAME --region us-east-1 --force || echo "-> Repositorio $REPO_NAME no encontrado o ya eliminado."
          done

      - name: ğŸ—‘ï¸ Eliminar Backend de Terraform (S3 y DynamoDB)
        continue-on-error: true
        run: |
          S3_BUCKET="proyecto06-terraform-state-eks"
          DYNAMO_TABLE="proyecto06-terraform-lock-eks"
          
          echo "Vaciando y eliminando bucket S3 para el estado de Terraform..."
          aws s3 rb "s3://$S3_BUCKET" --force || echo "-> Bucket S3 '$S3_BUCKET' no encontrado o ya eliminado."
          
          echo "Eliminando tabla DynamoDB para el bloqueo de Terraform..."
          aws dynamodb delete-table --table-name $DYNAMO_TABLE --region us-east-1 || echo "-> Tabla DynamoDB '$DYNAMO_TABLE' no encontrada o ya eliminada."

      - name: âœ… Limpieza completada
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘      âœ“ INFRAESTRUCTURA DESTRUIDA EXITOSAMENTE      â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "Resumen de la limpieza:"
          echo "  - Recursos de Terraform (EKS, VPC, etc.) destruidos."
          echo "  - Repositorios ECR (frontend, backend, database) eliminados."
          echo "  - Backend de Terraform (S3, DynamoDB) eliminado."
          echo ""
