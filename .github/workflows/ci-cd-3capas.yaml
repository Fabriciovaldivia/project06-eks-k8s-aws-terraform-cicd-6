name: ğŸš€ CI-CD-Proyecto06-3Capas

on:
  workflow_dispatch: # Se activa manualmente desde GitHub Actions

jobs:
  build-and-push:
    name: ğŸ—ï¸ Construir y Subir ImÃ¡genes
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        include:
          - service: frontend
            dockerfile: ./frontend/Dockerfile
            context: ./frontend
          - service: backend
            dockerfile: ./backend/Dockerfile
            context: ./backend
          - service: database
            dockerfile: ./database/Dockerfile
            context: ./database

    steps:
      - name: ğŸ“¥ Descargar cÃ³digo del repositorio
        uses: actions/checkout@v4

      - name: âœ… Verificar archivos necesarios
        run: |
          echo "Verificando archivos para ${{ matrix.service }}..."
          test -f ${{ matrix.dockerfile }} || (echo "ERROR: Dockerfile no encontrado en ${{ matrix.dockerfile }}" && exit 1)
          test -d ${{ matrix.context }} || (echo "ERROR: Directorio no encontrado ${{ matrix.context }}" && exit 1)
          
          if [ "${{ matrix.service }}" = "database" ]; then
            test -f ${{ matrix.context }}/init.sql || (echo "ERROR: init.sql no encontrado" && exit 1)
          fi
          
          ls -la ${{ matrix.context }}/
          echo "âœ“ Archivos verificados correctamente"

      - name: ğŸ” Configurar credenciales de AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_KEY }}
          aws-region: us-east-1

      - name: ğŸ› ï¸ Crear repositorio ECR si no existe
        run: |
          SERVICE_NAME="proyecto06-${{ matrix.service }}"
          aws ecr describe-repositories --repository-names $SERVICE_NAME --region us-east-1 || \
          aws ecr create-repository --repository-name $SERVICE_NAME --region us-east-1 || echo "Repositorio ya existe"

      - name: ğŸ”‘ Autenticarse en Amazon ECR
        run: |
          aws ecr get-login-password --region us-east-1 | \
          docker login --username AWS --password-stdin ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.us-east-1.amazonaws.com

      - name: ğŸ—ï¸ Construir imagen Docker - ${{ matrix.service }}
        run: |
          cd ${{ matrix.context }}
          docker build -t proyecto06-${{ matrix.service }}:latest .
          cd -

      - name: ğŸ“¦ Etiquetar imagen para ECR - ${{ matrix.service }}
        run: |
          docker tag proyecto06-${{ matrix.service }}:latest \
            ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.us-east-1.amazonaws.com/proyecto06-${{ matrix.service }}:latest
          docker tag proyecto06-${{ matrix.service }}:latest \
            ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.us-east-1.amazonaws.com/proyecto06-${{ matrix.service }}:${{ github.sha }}

      - name: ğŸš€ Subir imagen a Amazon ECR - ${{ matrix.service }}
        run: |
          docker push ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.us-east-1.amazonaws.com/proyecto06-${{ matrix.service }}:latest
          docker push ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.us-east-1.amazonaws.com/proyecto06-${{ matrix.service }}:${{ github.sha }}
          echo "Imagen subida correctamente para ${{ matrix.service }}"

  deploy-to-eks:
    name: ğŸš€ Desplegar en EKS
    needs: build-and-push
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Descargar cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ” Configurar credenciales de AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_KEY }}
          aws-region: us-east-1

      - name: ğŸ› ï¸ Crear Backend S3 y DynamoDB para Terraform
        run: |
          aws s3api head-bucket --bucket proyecto06-terraform-state-eks 2>/dev/null || aws s3api create-bucket --bucket proyecto06-terraform-state-eks --region us-east-1
          aws dynamodb describe-table --table-name proyecto06-terraform-lock-eks --region us-east-1 2>/dev/null || aws dynamodb create-table --table-name proyecto06-terraform-lock-eks --attribute-definitions AttributeName=LockID,AttributeType=S --key-schema AttributeName=LockID,KeyType=HASH --provisioned-throughput ReadCapacityUnits=1,WriteCapacityUnits=1 --region us-east-1

      - name: ğŸ”§ Configurar Terraform
        uses: hashicorp/setup-terraform@v3

      - name: ğŸ—ï¸ Inicializar Terraform
        run: |
          cd terraform
          terraform init -upgrade
          cd ..

      - name: ğŸš€ Aplicar Terraform
        run: |
          cd terraform
          terraform apply -auto-approve -input=false
          cd ..

      - name: âœ… Actualizar kubeconfig
        run: |
          echo "Actualizando kubeconfig para cluster proyecto06-eks..."
          aws eks update-kubeconfig --name proyecto06-eks --region us-east-1
          echo "Verificando conexiÃ³n a Kubernetes..."
          kubectl cluster-info
          kubectl version --client
          echo "âœ“ Kubeconfig actualizado correctamente"

      - name: â›‘ï¸ Install AWS Load Balancer Controller via Helm
        run: |
          echo "Instalando AWS Load Balancer Controller..."
          helm repo add eks https://aws.github.io/eks-charts
          helm repo update
          helm upgrade --install aws-load-balancer-controller eks/aws-load-balancer-controller \
            -n kube-system \
            --set clusterName=proyecto06-eks \
            --set serviceAccount.create=true \
            --set serviceAccount.name=aws-load-balancer-controller \
            --set serviceAccount.annotations."eks\.amazonaws\.com/role-arn"="arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/proyecto06-eks-alb-controller-role"

      - name: â³ Wait for Load Balancer Controller to be ready
        run: |
          echo "Esperando a que el AWS Load Balancer Controller estÃ© listo..."
          kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=aws-load-balancer-controller -n kube-system --timeout=300s
          echo "âœ“ AWS Load Balancer Controller estÃ¡ listo."

      - name: ğŸ“ Crear namespace y ConfigMap
        run: |
          echo "Creando namespace proyecto06..."
          kubectl apply -f k8s/00-namespace.yaml
          sleep 2
          echo "âœ“ Namespace creado"

      - name: ğŸ—„ï¸ Desplegar Base de Datos
        run: |
          echo "Desplegando base de datos..."
          kubectl apply -f k8s/01-database.yaml
          echo "Esperando a que la base de datos estÃ© lista (timeout: 5 min)..."
          kubectl wait --for=condition=ready pod -l app=database -n proyecto06 --timeout=300s || echo "âš ï¸ Timeout, continuando..."
          sleep 10
          kubectl get pods -n proyecto06
          echo "âœ“ Base de datos desplegada"

      - name: ğŸ”™ Desplegar Backend
        run: |
          echo "Desplegando backend..."
          kubectl apply -f k8s/02-backend.yaml
          echo "Esperando a que el backend estÃ© listo (timeout: 5 min)..."
          kubectl wait --for=condition=ready pod -l app=backend -n proyecto06 --timeout=300s || echo "âš ï¸ Timeout, continuando..."
          sleep 10
          kubectl get pods -n proyecto06
          echo "âœ“ Backend desplegado"

      - name: ğŸ¨ Desplegar Frontend
        run: |
          echo "Desplegando frontend..."
          kubectl apply -f k8s/03-frontend.yaml
          echo "Esperando a que el frontend estÃ© listo (timeout: 5 min)..."
          kubectl wait --for=condition=ready pod -l app=frontend -n proyecto06 --timeout=300s || echo "âš ï¸ Timeout, continuando..."
          sleep 10
          kubectl get pods -n proyecto06
          echo "âœ“ Frontend desplegado"

      - name: ğŸŒ Desplegar Ingress
        run: |
          echo "Desplegando Ingress..."
          kubectl apply -f k8s/04-ingress.yaml
          echo "Esperando a que el Load Balancer obtenga una direcciÃ³n (timeout: 5 min)..."
          # No usamos 'wait' aquÃ­ porque el Ingress no tiene una condiciÃ³n 'ready' estÃ¡ndar.
          # Simplemente esperamos un poco y mostramos el estado.
          sleep 60 
          kubectl get ingress -n proyecto06
          echo "âœ“ Solicitud de Ingress enviada"

      - name: âœ¨ Obtener URLs de acceso
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  âœ“ DEPLOYMENT COMPLETADO EXITOSAMENTE             â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ“Š SERVICIOS DESPLEGADOS:"
          echo ""
          echo "ğŸŒ Ingress (Application Load Balancer):"
          kubectl get ingress proyecto06-ingress -n proyecto06 || echo "  (Pendiente de asignaciÃ³n de URL, puede tardar unos minutos)"
          echo ""
          echo "ğŸ”™ Backend (ClusterIP):"
          kubectl get svc backend-service -n proyecto06
          echo ""
          echo "ğŸ—„ï¸ Database (Headless):"
          kubectl get svc database-service -n proyecto06
          echo ""
          echo "ğŸ“Œ PODS EN EJECUCIÃ“N:"
          kubectl get pods -n proyecto06 -o wide
          echo ""
          echo "ğŸ“ˆ DEPLOYMENTS:"
          kubectl get deployments -n proyecto06
          echo ""
          echo "âœ“ Pipeline completado exitosamente!"
