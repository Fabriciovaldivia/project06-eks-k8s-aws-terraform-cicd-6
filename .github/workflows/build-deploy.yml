name: Build & Deploy Proyecto06

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main

env:
  AWS_REGION: us-east-1
  PROJECT_NAME: proyecto06

jobs:
  build-database:
    name: Build Database
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Verify init.sql exists
        run: |
          ls -la database/
          test -f database/init.sql || exit 1
      
      - name: Build database image
        run: |
          cd database
          docker build -t ${{ env.PROJECT_NAME }}-database:${{ github.sha }} .
          docker tag ${{ env.PROJECT_NAME }}-database:${{ github.sha }} ${{ env.PROJECT_NAME }}-database:latest

  build-backend:
    name: Build Backend
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Verify Dockerfile exists
        run: test -f backend/Dockerfile
      
      - name: Build backend image
        run: |
          cd backend
          docker build -t ${{ env.PROJECT_NAME }}-backend:${{ github.sha }} .
          docker tag ${{ env.PROJECT_NAME }}-backend:${{ github.sha }} ${{ env.PROJECT_NAME }}-backend:latest

  build-frontend:
    name: Build Frontend
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Verify Dockerfile exists
        run: test -f frontend/Dockerfile
      
      - name: Build frontend image
        run: |
          cd frontend
          docker build -t ${{ env.PROJECT_NAME }}-frontend:${{ github.sha }} .
          docker tag ${{ env.PROJECT_NAME }}-frontend:${{ github.sha }} ${{ env.PROJECT_NAME }}-frontend:latest

  push-ecr:
    name: Push to ECR
    runs-on: ubuntu-latest
    needs: [build-database, build-backend, build-frontend]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v1

      - name: Build and push database
        env:
          REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        run: |
          cd database
          docker build -t $REGISTRY/${{ env.PROJECT_NAME }}-database:${{ github.sha }} .
          docker tag $REGISTRY/${{ env.PROJECT_NAME }}-database:${{ github.sha }} $REGISTRY/${{ env.PROJECT_NAME }}-database:latest
          docker push $REGISTRY/${{ env.PROJECT_NAME }}-database:${{ github.sha }}
          docker push $REGISTRY/${{ env.PROJECT_NAME }}-database:latest

      - name: Build and push backend
        env:
          REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        run: |
          cd backend
          docker build -t $REGISTRY/${{ env.PROJECT_NAME }}-backend:${{ github.sha }} .
          docker tag $REGISTRY/${{ env.PROJECT_NAME }}-backend:${{ github.sha }} $REGISTRY/${{ env.PROJECT_NAME }}-backend:latest
          docker push $REGISTRY/${{ env.PROJECT_NAME }}-backend:${{ github.sha }}
          docker push $REGISTRY/${{ env.PROJECT_NAME }}-backend:latest

      - name: Build and push frontend
        env:
          REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        run: |
          cd frontend
          docker build -t $REGISTRY/${{ env.PROJECT_NAME }}-frontend:${{ github.sha }} .
          docker tag $REGISTRY/${{ env.PROJECT_NAME }}-frontend:${{ github.sha }} $REGISTRY/${{ env.PROJECT_NAME }}-frontend:latest
          docker push $REGISTRY/${{ env.PROJECT_NAME }}-frontend:${{ github.sha }}
          docker push $REGISTRY/${{ env.PROJECT_NAME }}-frontend:latest

  deploy:
    name: Deploy to EKS
    runs-on: ubuntu-latest
    needs: push-ecr
    if: github.ref == 'refs/heads/main'
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Update kubeconfig
        run: |
          aws eks update-kubeconfig \
            --name proyecto06-eks \
            --region ${{ env.AWS_REGION }}

      - name: Get AWS Account ID
        id: account
        run: |
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          echo "account_id=$ACCOUNT_ID" >> $GITHUB_OUTPUT

      - name: Update manifests
        run: |
          ACCOUNT_ID=${{ steps.account.outputs.account_id }}
          for file in k8s/*.yaml; do
            sed -i "s|<ACCOUNT_ID>|$ACCOUNT_ID|g" "$file"
          done

      - name: Apply Kubernetes manifests
        run: |
          kubectl create namespace proyecto06 --dry-run=client -o yaml | kubectl apply -f -
          kubectl apply -f k8s/00-namespace.yaml
          sleep 2
          kubectl apply -f k8s/01-database.yaml
          sleep 5
          kubectl apply -f k8s/02-backend.yaml
          sleep 5
          kubectl apply -f k8s/03-frontend.yaml

      - name: Verify deployment
        run: |
          kubectl get pods -n proyecto06
          kubectl get svc -n proyecto06
